<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="877" height="1369" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[小程序->格灵 server: wx.login() \n code + appid
格灵 server -> 微信 server: auth.code2Session 接口 \n appid + secretid + code
微信 server -> 格灵 server: 用户 openid、unionId 等等
Note over 格灵 server: 后端检测用户是否注册过
Note over 格灵 server: 已注册:返回 token
格灵 server-->小程序: token
Note left of 小程序: 存储 token \n 跳转游戏码页面
Note over 格灵 server: 未注册：走注册流程

格灵 server-->小程序: 通知用户为新用户
Note over 小程序: 弹窗申请获取用户手机号 \n wx.getPhoneNumber()
小程序->格灵 server: getPhoneNumber code
格灵 server -> 微信 server: phonenumber.getPhoneNumber 接口 \n access_token + getPhoneNumber code
微信 server -> 格灵 server: 用户手机号、区号等
Note over 格灵 server: 利用手机号等信息注册
格灵 server->小程序: 注册成功: 返回 token + userid
Note left of 小程序: 存储 token
Note over 小程序: 用户填写昵称 头像 性别等信息
小程序 -> 格灵 server: userid + 用户信息
Note over 格灵 server: 更新用户基础信息
格灵 server->小程序: 完成注册
Note left of 小程序:  跳转游戏码页面

Note over 小程序: 登录状态
小程序->格灵 server: 业务接口 \n 请求头携带 token
Note over 格灵 server: token 过期
格灵 server->小程序: 401

Note over 格灵 server: 回到第一步 wx.login()
]]></source><desc></desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"></g><g class="actor"><rect x="128" y="20" width="68" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="138" y="44.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="138">小程序</tspan></text></g><g class="actor"><rect x="128" y="1311.2000045776367" width="68" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="138" y="1335.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="138">小程序</tspan></text></g><line x1="162" x2="162" y1="58" y2="1311.2000045776367" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="381.62109375" y="20" width="119.2109375" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="391.62109375" y="44.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="391.62109375">格灵 server</tspan></text></g><g class="actor"><rect x="381.62109375" y="1311.2000045776367" width="119.2109375" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="391.62109375" y="1335.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="391.62109375">格灵 server</tspan></text></g><line x1="441.2265625" x2="441.2265625" y1="58" y2="1311.2000045776367" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="728.07421875" y="20" width="119.2109375" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="738.07421875" y="44.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="738.07421875">微信 server</tspan></text></g><g class="actor"><rect x="728.07421875" y="1311.2000045776367" width="119.2109375" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="738.07421875" y="1335.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="738.07421875">微信 server</tspan></text></g><line x1="787.6796875" x2="787.6796875" y1="58" y2="1311.2000045776367" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="244.00390625" y="78.89999961853027" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="244.00390625">wx.login()</tspan><tspan dy="1.2em" x="244.00390625">code + appid</tspan></text><line x1="162" x2="441.2265625" y1="115.20000076293945" y2="115.20000076293945" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="504.03515625" y="136.10000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="504.03515625">auth.code2Session 接口</tspan><tspan dy="1.2em" x="504.03515625">appid + secretid + code</tspan></text><line x1="441.2265625" x2="787.6796875" y1="172.4000015258789" y2="172.4000015258789" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="502.44140625" y="202.9000015258789" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="502.44140625">用户 openid、unionId 等等</tspan></text><line x1="787.6796875" x2="441.2265625" y1="210.4000015258789" y2="210.4000015258789" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="348.2265625" y="230.4000015258789" width="186" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="353.2265625" y="249.9000015258789" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="353.2265625">后端检测用户是否注册过</tspan></text></g><g class="note"><rect x="362.62109375" y="278.4000015258789" width="157.2109375" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="367.62109375" y="297.9000015258789" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="367.62109375">已注册:返回 token</tspan></text></g><g class="signal"><text x="277.609375" y="336.9000015258789" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="277.609375">token</tspan></text><line x1="441.2265625" x2="162" y1="344.4000015258789" y2="344.4000015258789" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="20" y="364.4000015258789" width="122" height="47.20000076293945" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="25" y="383.9000015258789" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="25">存储 token</tspan><tspan dy="1.2em" x="25">跳转游戏码页面</tspan></text></g><g class="note"><rect x="364.2265625" y="431.60000228881836" width="154" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="369.2265625" y="451.10000228881836" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="369.2265625">未注册：走注册流程</tspan></text></g><g class="signal"><text x="237.61328125" y="490.10000228881836" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="237.61328125">通知用户为新用户</tspan></text><line x1="441.2265625" x2="162" y1="497.60000228881836" y2="497.60000228881836" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="65.78515625" y="517.6000022888184" width="192.4296875" height="47.20000076293945" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="70.78515625" y="537.1000022888184" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="70.78515625">弹窗申请获取用户手机号</tspan><tspan dy="1.2em" x="70.78515625">wx.getPhoneNumber()</tspan></text></g><g class="signal"><text x="210.3984375" y="595.3000030517578" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="210.3984375">getPhoneNumber code</tspan></text><line x1="162" x2="441.2265625" y1="602.8000030517578" y2="602.8000030517578" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="451.2265625" y="623.7000026702881" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="451.2265625">phonenumber.getPhoneNumber 接口</tspan><tspan dy="1.2em" x="451.2265625">access_token + getPhoneNumber code</tspan></text><line x1="441.2265625" x2="787.6796875" y1="660.0000038146973" y2="660.0000038146973" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="542.453125" y="690.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="542.453125">用户手机号、区号等</tspan></text><line x1="787.6796875" x2="441.2265625" y1="698.0000038146973" y2="698.0000038146973" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="356.2265625" y="718.0000038146973" width="170" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="361.2265625" y="737.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="361.2265625">利用手机号等信息注册</tspan></text></g><g class="signal"><text x="172" y="776.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="172">注册成功: 返回 token + userid</tspan></text><line x1="441.2265625" x2="162" y1="784.0000038146973" y2="784.0000038146973" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="42.390625" y="804.0000038146973" width="99.609375" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="47.390625" y="823.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="47.390625">存储 token</tspan></text></g><g class="note"><rect x="43.3984375" y="852.0000038146973" width="237.203125" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="48.3984375" y="871.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="48.3984375">用户填写昵称 头像 性别等信息</tspan></text></g><g class="signal"><text x="226.40625" y="910.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="226.40625">userid + 用户信息</tspan></text><line x1="162" x2="441.2265625" y1="918.0000038146973" y2="918.0000038146973" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="372.2265625" y="938.0000038146973" width="138" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="377.2265625" y="957.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="377.2265625">更新用户基础信息</tspan></text></g><g class="signal"><text x="269.61328125" y="996.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="269.61328125">完成注册</tspan></text><line x1="441.2265625" x2="162" y1="1004.0000038146973" y2="1004.0000038146973" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="20" y="1024.0000038146973" width="122" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="25" y="1043.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="25">跳转游戏码页面</tspan></text></g><g class="note"><rect x="125" y="1072.0000038146973" width="74" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="130" y="1091.5000038146973" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="130">登录状态</tspan></text></g><g class="signal"><text x="232.80859375" y="1120.9000034332275" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="232.80859375">业务接口</tspan><tspan dy="1.2em" x="232.80859375">请求头携带 token</tspan></text><line x1="162" x2="441.2265625" y1="1157.2000045776367" y2="1157.2000045776367" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="391.421875" y="1177.2000045776367" width="99.609375" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="396.421875" y="1196.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="396.421875">token 过期</tspan></text></g><g class="signal"><text x="287.2109375" y="1235.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="287.2109375">401</tspan></text><line x1="441.2265625" x2="162" y1="1243.2000045776367" y2="1243.2000045776367" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="343.41796875" y="1263.2000045776367" width="195.6171875" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="348.41796875" y="1282.7000045776367" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="348.41796875">回到第一步 wx.login()</tspan></text></g></svg>